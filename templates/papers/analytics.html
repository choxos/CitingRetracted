{% extends 'prct_base.html' %}
{% load static %}

{% block title %}Analytics - Post-Retraction Citation Tracker{% endblock %}

{% block extra_css %}
<style>
/* ===============================================
   PRCT ANALYTICS CHART STYLES - PRESERVE ALL!
   =============================================== */

.chart-container {
    position: relative;
    height: 400px;
    margin: 20px 0;
    background: white;
    border-radius: var(--xera-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--xera-shadow-md);
    overflow: hidden; /* Prevent charts from overflowing */
}

.chart-container.tall {
    height: 500px;
}

.chart-container.short {
    height: 300px;
}

/* Ensure all chart elements stay within bounds */
.chart-container canvas,
.chart-container svg,
.chart-container div {
    max-width: 100%;
    max-height: 100%;
}

/* Sunburst chart specific sizing */
#sunburstChart {
    width: 100%;
    height: 320px;
    overflow: hidden;
}

/* World map responsive sizing */
#worldMap {
    max-width: 100%;
    overflow: hidden;
}

#plotlyWorldMap {
    max-width: 100%;
    overflow: hidden;
}

.interactive-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 15px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.legend-item:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.legend-item.inactive {
    opacity: 0.5;
}

/* Enhanced PRCT Stat Cards */
.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.chart-controls {
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.network-tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    pointer-events: none;
    z-index: 1000;
    font-size: 12px;
    max-width: 200px;
}

.dashboard-tabs {
    margin-bottom: 30px;
}

.dashboard-tabs .nav-link {
    border-radius: 25px;
    margin-right: 10px;
    transition: all 0.3s ease;
}

.dashboard-tabs .nav-link.active {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
}

.chart-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #6c757d;
}

.data-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.progress-ring {
    transform: rotate(-90deg);
}

.progress-ring-circle {
    transition: stroke-dashoffset 0.35s;
    transform-origin: 50% 50%;
}

/* Mobile-responsive heatmap styles */
.heatmap-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .heatmap-container {
        padding: 10px !important;
        font-size: 11px !important;
    }
    
    .heatmap-table {
        min-width: 600px;
    }
    
    .heatmap-table th,
    .heatmap-table td {
        padding: 6px 4px !important;
        font-size: 10px !important;
        min-width: 60px !important;
    }
    
    .heatmap-container .legend {
        flex-direction: column !important;
        gap: 4px !important;
    }
    
    .chart-container {
        height: 300px;
        margin: 15px 0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="xera-container-fluid">
    <!-- PRCT Analytics Header -->
    <div class="xera-card mb-4">
        <div class="xera-card-header">
            <h1 class="prct-chart-title">
                <i class="fas fa-chart-bar"></i> Advanced Analytics Dashboard
            </h1>
            <p class="text-muted mb-0">Interactive visualization of retracted papers and citation patterns with advanced filtering and drill-down capabilities.</p>
        </div>
    </div>
    
    <!-- Real-time Update Controls -->
    <div class="xera-card mb-4">
        <div class="xera-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                            <label class="form-check-label" for="autoRefreshToggle">
                                <i class="fas fa-sync-alt"></i> Auto-refresh
                            </label>
                        </div>
                        <select class="xera-form-control xera-form-control-sm" id="refreshInterval" style="width: auto;" disabled>
                            <option value="30000">30 seconds</option>
                            <option value="60000" selected>1 minute</option>
                            <option value="300000">5 minutes</option>
                            <option value="600000">10 minutes</option>
                        </select>
                        <button class="xera-btn xera-btn-sm xera-btn-outline-primary" id="manualRefresh">
                            <i class="fas fa-refresh"></i> Refresh Now
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex align-items-center justify-content-end gap-2">
                        <small class="text-muted">Last updated:</small>
                        <span id="lastUpdated" class="xera-badge xera-badge-secondary">{{ "now"|date:"M d, Y H:i" }}</span>
                        <div id="updateStatus" class="xera-badge xera-badge-success" style="display: none;">
                            <i class="fas fa-check"></i> Updated
                        </div>
                        <div id="updateLoading" class="spinner-border spinner-border-sm text-primary" style="display: none;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PRCT Analytics Navigation Tabs -->
    <div class="xera-card mb-4">
        <div class="xera-card-header p-0">
            <ul class="nav nav-pills dashboard-tabs xera-nav-tabs" id="analyticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="pill" data-bs-target="#trends" type="button" role="tab">
                        <i class="fas fa-chart-line"></i> Trends
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="patterns-tab" data-bs-toggle="pill" data-bs-target="#patterns" type="button" role="tab">
                        <i class="fas fa-search"></i> Patterns
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="network-tab" data-bs-toggle="pill" data-bs-target="#network" type="button" role="tab">
                        <i class="fas fa-project-diagram"></i> Network
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="analyticsTabContent">
        
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <!-- Summary Statistics -->
            <div class="row mb-5">
                <div class="col-md-3 mb-4">
                    <div class="prct-stat-card h-100 text-center">
                        <i class="fas fa-ban fa-3x text-danger mb-3"></i>
                        <h3 class="prct-stat-number">{{ stats.total_papers|floatformat:0 }}</h3>
                        <p class="prct-stat-label">Total Retracted Papers</p>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="prct-stat-card h-100 text-center">
                        <i class="fas fa-quote-right fa-3x text-warning mb-3"></i>
                        <h3 class="prct-stat-number">{{ stats.total_citations|floatformat:0 }}</h3>
                        <p class="prct-stat-label">Total Citations</p>
                        <small class="text-muted">
                            <strong>Mean:</strong> {{ stats.avg_citations_per_paper|floatformat:1 }} (SD: {{ stats.stdev_citations_per_paper|floatformat:1 }})<br>
                            <strong>Median:</strong> {{ stats.median_citations_per_paper|floatformat:1 }} (Q1: {{ stats.q1_citations_per_paper|floatformat:1 }}, Q3: {{ stats.q3_citations_per_paper|floatformat:1 }})
                            {% if stats.avg_citations_per_paper > stats.median_citations_per_paper|add:1 %}
                                <br><span class="text-info"><i class="fas fa-info-circle"></i> Skewed distribution</span>
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="prct-stat-card h-100 text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h3 class="prct-stat-number">{{ stats.post_retraction_citations|floatformat:0 }}</h3>
                        <p class="prct-stat-label">Post-Retraction Citations</p>
                        <div class="mt-2">
                            <span class="prct-retraction-badge retracted">{{ stats.post_retraction_percentage|floatformat:1 }}% of total</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="prct-stat-card h-100 text-center">
                        <i class="fas fa-clock fa-3x text-success mb-3"></i>
                        <h3 class="prct-stat-number">{{ stats.recent_retractions|floatformat:0 }}</h3>
                        <p class="prct-stat-label">Recent Retractions</p>
                        <small class="text-muted">Last 12 months</small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Charts Row -->
            <div class="row mb-5">
                <div class="col-lg-6 mb-4">
                    <div class="prct-chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="prct-chart-title"><i class="fas fa-chart-pie"></i> Citation Patterns</h5>
                            <button class="xera-btn xera-btn-sm xera-btn-outline-primary" onclick="refreshChart('citationPatternsChart')">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="chart-container short">
                            <canvas id="citationPatternsChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="prct-retraction-badge retracted fs-6">
                                {{ citation_patterns.post_retraction_percentage|floatformat:1 }}% post-retraction
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-clock"></i> Post-Retraction Timeline</h5>
                        <div class="chart-container short">
                            <canvas id="postRetractionTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trends Tab -->
        <div class="tab-pane fade" id="trends" role="tabpanel">
            <!-- Time Range Controls -->
            <div class="xera-card mb-4">
                <div class="xera-card-body">
                    <div class="filter-group">
                        <label><strong>Time Range:</strong></label>
                        <select class="xera-form-control xera-form-control-sm" id="timeRangeFilter" style="width: auto;">
                            <option value="all">All Time</option>
                            <option value="5y">Last 5 Years</option>
                            <option value="3y">Last 3 Years</option>
                            <option value="1y">Last Year</option>
                        </select>
                        <button class="xera-btn xera-btn-sm xera-btn-primary" onclick="updateTrendCharts()">
                            <i class="fas fa-filter"></i> Apply Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Retraction Trends Chart -->
            <div class="row mb-5">
                <div class="col-12 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-chart-line"></i> Retraction Trends Over Time</h5>
                        <div class="chart-container">
                            <canvas id="retractionsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Citation Comparison & Subject Distribution -->
            <div class="row mb-5">
                <div class="col-lg-8 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-chart-area"></i> Citation Comparison: Before vs After Retraction</h5>
                        <div class="chart-container">
                            <canvas id="citationComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-chart-bar"></i> Subject Distribution</h5>
                        <div class="chart-container">
                            <canvas id="subjectDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Patterns Tab -->
        <div class="tab-pane fade" id="patterns" role="tabpanel">
            <!-- Citation Heatmap & Timing Distribution -->
            <div class="row mb-5">
                <div class="col-lg-8 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-th"></i> Citation Heatmap</h5>
                        <small class="text-muted">Citations by month and time after retraction</small>
                        <div class="chart-container">
                            <canvas id="citationHeatmapChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-chart-line"></i> Citation Timing Distribution</h5>
                        <div class="chart-container">
                            <canvas id="citationTimingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Journal Impact & Subject Sunburst -->
            <div class="row mb-5">
                <div class="col-lg-8 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-circle-notch"></i> Journal Impact Analysis</h5>
                        <small class="text-muted">Bubble size represents average citations per paper</small>
                        <div class="chart-container tall">
                            <canvas id="journalBubbleChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-sun"></i> Subject Hierarchy Sunburst</h5>
                        <small class="text-muted">Interactive hierarchy of broad subjects and specific fields</small>
                        <div class="chart-container">
                            <div id="sunburstChart"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Geographic & Article Type Analysis -->
            <div class="row mb-5">
                <div class="col-lg-8 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-globe"></i> Geographic Distribution</h5>
                        <small class="text-muted">Retractions by country with open access rates</small>
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-file-alt"></i> Article Type Analysis</h5>
                        <small class="text-muted">Distribution by article type</small>
                        <div class="chart-container">
                            <canvas id="articleTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Publisher & Open Access Analysis -->
            <div class="row mb-5">
                <div class="col-lg-8 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-university"></i> Publisher Analysis</h5>
                        <small class="text-muted">Top publishers with retraction issues</small>
                        <div class="chart-container">
                            <canvas id="publisherChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-unlock"></i> Open Access Analysis</h5>
                        <small class="text-muted">Access status distribution</small>
                        <div class="chart-container">
                            <canvas id="openAccessChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-success">
                                        <i class="fas fa-unlock fa-2x"></i>
                                        <div><strong>{{ access_analytics.open_access.count }}</strong></div>
                                        <small>Open Access</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-warning">
                                        <i class="fas fa-lock fa-2x"></i>
                                        <div><strong>{{ access_analytics.paywalled.count }}</strong></div>
                                        <small>Paywalled</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted">
                                        <i class="fas fa-question fa-2x"></i>
                                        <div><strong>{{ access_analytics.unknown.count }}</strong></div>
                                        <small>Unknown</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Problematic Papers Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-exclamation-triangle"></i> Most Problematic Papers</h5>
                            <small class="text-muted">Papers with highest post-retraction citation counts</small>
                        </div>
                        <div class="card-body">
                            <div class="data-table-container">
                                <table class="table table-hover table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Title</th>
                                            <th>Journal</th>
                                            <th>Country</th>
                                            <th>Institution</th>
                                            <th>Access</th>
                                            <th>Retraction Date</th>
                                            <th>Post-Retraction Citations</th>
                                            <th>Citation Rate</th>
                                            <th>Links</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for paper in problematic_papers_detailed|slice:":5" %}
                                        <tr>
                                            <td>
                                                <strong>{{ paper.title }}</strong>
                                                {% if paper.formatted_reasons %}
                                                <br><small class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ paper.formatted_reasons|truncatechars:80 }}</small>
                                                {% endif %}
                                                {% if paper.formatted_subjects %}
                                                <br><small class="text-info"><i class="fas fa-tag"></i> {{ paper.formatted_subjects|truncatechars:60 }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ paper.journal|default:"Unknown" }}</td>
                                            <td>
                                                {% if paper.countries %}
                                                    {% for country in paper.countries %}
                                                        <span class="badge bg-primary me-1 mb-1">{{ country }}</span>
                                                    {% endfor %}
                                                    {% if paper.country_count > 3 %}
                                                        <small class="text-muted d-block">+{{ paper.country_count|add:'-3' }} more</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small>{{ paper.institution|default:"Unknown" }}</small>
                                            </td>
                                            <td>
                                                {% if paper.access_status == "Open Access" %}
                                                    <span class="badge bg-success"><i class="fas fa-unlock"></i> Open</span>
                                                {% elif paper.access_status == "Paywalled" %}
                                                    <span class="badge bg-warning"><i class="fas fa-lock"></i> Paywalled</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if paper.retraction_date %}
                                                    {{ paper.retraction_date }}
                                                    <br><small class="text-muted">{{ paper.days_since_retraction }} days ago</small>
                                                    {% if paper.formatted_reasons %}
                                                        <br><small class="text-danger"><strong>{{ paper.formatted_reasons|truncatechars:50 }}</strong></small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-danger">{{ paper.post_retraction_citations }}</span>
                                                <br><small class="text-muted">of {{ paper.total_citations }} total</small>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-danger" 
                                                         style="width: {{ paper.citation_rate|floatformat:0 }}%">
                                                        {{ paper.citation_rate|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group-vertical" role="group">
                                                    <a href="{% url 'papers:detail' paper.record_id %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    {% if paper.original_paper_url %}
                                                    <a href="{{ paper.original_paper_url }}" target="_blank" class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-external-link-alt"></i> DOI
                                                    </a>
                                                    {% endif %}
                                                    {% if paper.pubmed_url %}
                                                    <a href="{{ paper.pubmed_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                        <i class="fas fa-book-medical"></i> PubMed
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="9" class="text-center text-muted">No problematic papers found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Network Tab -->
        <div class="tab-pane fade" id="network" role="tabpanel">
            <!-- Network Controls -->
            <div class="xera-card mb-4">
                <div class="xera-card-body">
                    <div class="filter-group">
                        <label><strong>Network View:</strong></label>
                        <select class="xera-form-control xera-form-control-sm" id="networkTypeFilter" style="width: auto;">
                            <option value="journals">Journal Relationships</option>
                            <option value="subjects">Subject Areas</option>
                            <option value="combined">Combined View</option>
                        </select>
                        <button class="xera-btn xera-btn-sm xera-btn-primary" onclick="updateNetworkChart()">
                            <i class="fas fa-project-diagram"></i> Update Network
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Interactive Network Visualization -->
            <div class="row">
                <div class="col-12">
                    <div class="prct-chart-container">
                        <h5 class="prct-chart-title"><i class="fas fa-project-diagram"></i> Interactive Network Analysis</h5>
                        <small class="text-muted">Click and drag nodes to explore relationships</small>
                        <div class="position-relative">
                            <div id="networkVisualization" style="height: 600px; border: 1px solid #dee2e6; border-radius: 8px;"></div>
                            <div id="networkTooltip" class="network-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Plotly.js for interactive choropleth maps -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- Chart.js (specific version for analytics) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<!-- D3.js for network visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// Global chart instances
let chartInstances = {};

// Chart color schemes
const colorSchemes = {
    primary: ['#007bff', '#6c757d', '#28a745', '#dc3545', '#ffc107', '#17a2b8'],
    danger: ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#6f42c1', '#e83e8c'],
    gradient: ['rgba(0,123,255,0.8)', 'rgba(40,167,69,0.8)', 'rgba(220,53,69,0.8)', 'rgba(255,193,7,0.8)']
};

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeOverviewCharts();
    
    // Initialize pattern charts immediately (including heatmap) so they're visible on page load
    initializePatternCharts();
    
    // Initialize charts when tabs are shown
    document.getElementById('trends-tab').addEventListener('shown.bs.tab', function() {
        // Destroy existing charts before reinitializing
        ['retractionsTimeline', 'citationComparison', 'subjectDistribution', 'retractionTrends'].forEach(chartKey => {
            if (chartInstances[chartKey]) {
                chartInstances[chartKey].destroy();
                delete chartInstances[chartKey];
            }
        });
        initializeTrendCharts();
    });
    
    document.getElementById('patterns-tab').addEventListener('shown.bs.tab', function() {
        // Destroy existing charts before reinitializing
        ['citationTiming', 'journalBubble', 'subjectDistribution', 'articleType', 'publisher', 'openAccess'].forEach(chartKey => {
            if (chartInstances[chartKey]) {
                chartInstances[chartKey].destroy();
                delete chartInstances[chartKey];
            }
        });
        initializePatternCharts();
    });
    
    document.getElementById('network-tab').addEventListener('shown.bs.tab', function() {
        initializeNetworkVisualization();
    });
});

function initializeOverviewCharts() {
    // Citation Patterns Pie Chart
    const citationPatternsData = {
        labels: ['Post-Retraction', 'Pre-Retraction', 'Same Day'],
        datasets: [{
            data: [
                {{ citation_patterns.post_retraction }},
                {{ citation_patterns.pre_retraction }},
                {{ citation_patterns.same_day }}
            ],
            backgroundColor: [
                'rgba(220, 53, 69, 0.8)',
                'rgba(40, 167, 69, 0.8)', 
                'rgba(255, 193, 7, 0.8)'
            ],
            borderColor: [
                'rgba(220, 53, 69, 1)',
                'rgba(40, 167, 69, 1)',
                'rgba(255, 193, 7, 1)'
            ],
            borderWidth: 2
        }]
    };
    
    chartInstances.citationPatterns = new Chart(
        document.getElementById('citationPatternsChart'),
        {
            type: 'doughnut',
            data: citationPatternsData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 2000
                }
            }
        }
    );
    
    // Post-Retraction Timeline Bar Chart
    const timelineData = {
        labels: ['Within 30 Days', 'Within 6 Months', 'Within 1 Year', 'Within 2 Years', 'After 2 Years'],
        datasets: [{
            label: 'Citations',
            data: [
                {{ post_retraction_timeline.within_30_days }},
                {{ post_retraction_timeline.within_6_months }},
                {{ post_retraction_timeline.within_1_year }},
                {{ post_retraction_timeline.within_2_years }},
                {{ post_retraction_timeline.after_2_years }}
            ],
            backgroundColor: 'rgba(220, 53, 69, 0.6)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
        }]
    };
    
    chartInstances.postRetractionTimeline = new Chart(
        document.getElementById('postRetractionTimelineChart'),
        {
            type: 'bar',
            data: timelineData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        }
    );
}

function initializeTrendCharts() {
    // Retraction trends over time
    const retractionYearsData = {{ retraction_years|safe }} || [];
    console.log('Retraction Years Data:', retractionYearsData);
    
    const retractionsTimelineData = {
        labels: retractionYearsData.map(item => item.year),
        datasets: [{
            label: 'Retractions',
            data: retractionYearsData.map(item => item.count),
            borderColor: 'rgba(220, 53, 69, 1)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };
    
    chartInstances.retractionsTimeline = new Chart(
        document.getElementById('retractionsTimelineChart'),
        {
            type: 'line',
            data: retractionsTimelineData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        }
    );
    
    // Citation comparison chart
    const comparisonData = {{ retraction_comparison|safe }} || [];
    console.log('Comparison Data:', comparisonData);
    
    const citationComparisonData = {
        labels: comparisonData.map(item => item.year || 'Unknown'),
        datasets: [
            {
                label: 'Pre-Retraction Citations',
                data: comparisonData.map(item => item.pre_retraction || 0),
                backgroundColor: 'rgba(40, 167, 69, 0.6)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2
            },
            {
                label: 'Post-Retraction Citations', 
                data: comparisonData.map(item => item.post_retraction || 0),
                backgroundColor: 'rgba(220, 53, 69, 0.6)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2
            }
        ]
    };
    
    chartInstances.citationComparison = new Chart(
        document.getElementById('citationComparisonChart'),
        {
            type: 'bar',
            data: citationComparisonData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Citations'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        }
    );
    
    // Subject distribution donut
    const subjectData = {{ subject_donut_data|safe }} || [];
    console.log('Subject Data:', subjectData);
    
    const subjectDistributionData = {
        labels: subjectData.map(item => (item.subject || 'Unknown').substring(0, 20) + ((item.subject || '').length > 20 ? '...' : '')),
        datasets: [{
            data: subjectData.map(item => item.count || 0),
            backgroundColor: colorSchemes.primary.slice(0, subjectData.length)
        }]
    };
    
    chartInstances.subjectDistribution = new Chart(
        document.getElementById('subjectDistributionChart'),
        {
            type: 'doughnut',
            data: subjectDistributionData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        }
    );
}

function initializePatternCharts() {
    // Citation timing distribution
    const timingData = {{ citation_timing_distribution|safe }} || [];
    console.log('Timing Data:', timingData);
    
    const citationTimingData = {
        labels: timingData.map(item => {
            if (item.days < 0) return 'Pre-Retraction';
            if (item.days === 0) return 'Same Day';
            return item.days + ' days';
        }),
        datasets: [{
            label: 'Citations',
            data: timingData.map(item => item.count),
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: 'rgba(0, 123, 255, 1)',
            borderWidth: 1
        }]
    };
    
    chartInstances.citationTiming = new Chart(
        document.getElementById('citationTimingChart'),
        {
            type: 'line',
            data: citationTimingData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time Period'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Citations'
                        }
                    }
                }
            }
        }
    );
    
    // Journal bubble chart
    const journalBubbleData = {{ journal_bubble_data|safe }} || [];
    
    const bubbleChartData = {
        datasets: [{
            label: 'Journals',
            data: journalBubbleData.map(item => ({
                x: item.x,
                y: item.y,
                r: Math.max(5, item.size || 5)
            })),
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: 'rgba(0, 123, 255, 1)'
        }]
    };
    
    chartInstances.journalBubble = new Chart(
        document.getElementById('journalBubbleChart'),
        {
            type: 'bubble',
            data: bubbleChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                const journal = journalBubbleData[dataIndex];
                                return [
                                    'Journal: ' + journal.journal,
                                    'Retractions: ' + journal.x,
                                    'Post-Retraction Citations: ' + journal.y,
                                    'Impact Score: ' + journal.impact_score
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Number of Retractions'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Post-Retraction Citations'
                        }
                    }
                }
            }
        }
    );
    
    // Citation Heatmap Chart - Custom implementation using HTML table
    const heatmapData = {{ citation_heatmap|safe }} || [];
    
    if (heatmapData && heatmapData.length > 0) {
        const heatmapContainer = document.getElementById('citationHeatmapChart').parentElement;
        
        // Hide the canvas and create a custom heatmap
        document.getElementById('citationHeatmapChart').style.display = 'none';
        
        // Create heatmap table
        const heatmapDiv = document.createElement('div');
        heatmapDiv.style.padding = '20px';
        heatmapDiv.style.overflowX = 'auto';
        heatmapDiv.classList.add('heatmap-container');
        
        // Add mobile-responsive styles
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            heatmapDiv.style.padding = '10px';
            heatmapDiv.style.fontSize = '11px';
        }
        
        const timeLabels = ['0-30 days', '30-90 days', '90-180 days', '180-365 days', '1-2 years', '2+ years'];
        const monthLabels = heatmapData.map(item => item.month);
        
        // Calculate column-wise max values for proper heat scaling
        const columnMaxValues = [];
        const columnMinValues = [];
        
        for (let timeIndex = 0; timeIndex < timeLabels.length; timeIndex++) {
            const columnValues = heatmapData.map(month => month.data[timeIndex]);
            columnMaxValues[timeIndex] = Math.max(...columnValues);
            columnMinValues[timeIndex] = Math.min(...columnValues);
        }
        
        // Create table
        const table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.style.width = '100%';
        table.style.fontSize = isMobile ? '10px' : '12px';
        table.classList.add('heatmap-table');
        
        // Add responsive table wrapper for better mobile experience
        if (isMobile) {
            table.style.minWidth = '600px'; // Ensure readability on mobile
        }
        
        // Create header row
        const headerRow = document.createElement('tr');
        const cornerCell = document.createElement('th');
        cornerCell.textContent = 'Month / Time Period';
        cornerCell.style.padding = '8px';
        cornerCell.style.border = '1px solid #ddd';
        cornerCell.style.backgroundColor = '#f8f9fa';
        cornerCell.style.fontWeight = 'bold';
        headerRow.appendChild(cornerCell);
        
        timeLabels.forEach((timeLabel, timeIndex) => {
            const th = document.createElement('th');
            if (isMobile) {
                // Shorter labels for mobile
                const shortLabels = ['0-30d', '30-90d', '90-180d', '180d-1y', '1-2y', '2y+'];
                th.innerHTML = `${shortLabels[timeIndex]}<br/><small style="font-weight: normal; font-size: 9px;">(${columnMinValues[timeIndex]}-${columnMaxValues[timeIndex].toLocaleString()})</small>`;
            } else {
                th.innerHTML = `${timeLabel}<br/><small style="font-weight: normal; font-size: 10px;">(${columnMinValues[timeIndex]}-${columnMaxValues[timeIndex].toLocaleString()})</small>`;
            }
            th.style.padding = isMobile ? '6px 4px' : '8px';
            th.style.border = '1px solid #ddd';
            th.style.backgroundColor = '#f8f9fa';
            th.style.fontWeight = 'bold';
            th.style.textAlign = 'center';
            th.style.minWidth = isMobile ? '60px' : '90px';
            th.style.lineHeight = '1.2';
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Create data rows
        heatmapData.forEach((monthData, monthIndex) => {
            const row = document.createElement('tr');
            
            // Month label
            const monthCell = document.createElement('td');
            monthCell.textContent = monthData.month;
            monthCell.style.padding = '8px';
            monthCell.style.border = '1px solid #ddd';
            monthCell.style.backgroundColor = '#f8f9fa';
            monthCell.style.fontWeight = 'bold';
            row.appendChild(monthCell);
            
            // Data cells with column-wise color scaling
            monthData.data.forEach((value, timeIndex) => {
                const cell = document.createElement('td');
                // Format numbers more compactly on mobile
                if (isMobile && value >= 1000) {
                    cell.textContent = (value / 1000).toFixed(1) + 'k';
                } else {
                    cell.textContent = value.toLocaleString();
                }
                cell.style.padding = isMobile ? '6px 4px' : '8px';
                cell.style.border = '1px solid #ddd';
                cell.style.textAlign = 'center';
                cell.style.cursor = 'pointer';
                cell.style.fontSize = isMobile ? '10px' : '12px';
                
                // Column-wise color intensity calculation
                const columnMax = columnMaxValues[timeIndex];
                const columnMin = columnMinValues[timeIndex];
                const columnRange = columnMax - columnMin;
                
                // Avoid division by zero and ensure meaningful scaling
                let intensity;
                if (columnRange === 0) {
                    intensity = 0.5; // Mid-intensity if all values are the same
                } else {
                    intensity = (value - columnMin) / columnRange;
                }
                
                // Enhanced color scaling with better contrast
                const alpha = Math.max(0.15, Math.min(0.9, intensity * 0.8 + 0.1));
                
                // Use different color schemes for different time periods
                let baseColor;
                if (timeIndex === 0) {
                    baseColor = '54, 162, 235'; // Blue for 0-30 days
                } else if (timeIndex === 1) {
                    baseColor = '75, 192, 192'; // Teal for 30-90 days
                } else if (timeIndex === 2) {
                    baseColor = '255, 206, 86'; // Yellow for 90-180 days
                } else if (timeIndex === 3) {
                    baseColor = '255, 159, 64'; // Orange for 180-365 days
                } else if (timeIndex === 4) {
                    baseColor = '255, 99, 132'; // Pink for 1-2 years
                } else {
                    baseColor = '153, 102, 255'; // Purple for 2+ years
                }
                
                cell.style.backgroundColor = `rgba(${baseColor}, ${alpha})`;
                cell.style.color = intensity > 0.6 ? 'white' : 'black';
                cell.style.fontWeight = intensity > 0.7 ? 'bold' : 'normal';
                
                // Enhanced tooltip with percentile information
                const columnValues = heatmapData.map(month => month.data[timeIndex]).sort((a, b) => b - a);
                const percentile = Math.round((1 - columnValues.indexOf(value) / columnValues.length) * 100);
                
                cell.title = `${monthData.month} - ${timeLabels[timeIndex]}\n${value.toLocaleString()} citations\n${percentile}th percentile in this time period\nColumn range: ${columnMin.toLocaleString()}-${columnMax.toLocaleString()}`;
                
                // Hover effect
                cell.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.zIndex = '10';
                    this.style.position = 'relative';
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                });
                
                cell.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.zIndex = 'auto';
                    this.style.position = 'static';
                    this.style.boxShadow = 'none';
                });
                
                row.appendChild(cell);
            });
            
            table.appendChild(row);
        });
        
        heatmapDiv.appendChild(table);
        
        // Add column-wise legend
        const legend = document.createElement('div');
        legend.style.marginTop = '15px';
        legend.style.textAlign = 'center';
        legend.style.fontSize = '11px';
        
        legend.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Color Scale:</strong> Each column uses its own intensity scale (dark = high for that time period)
            </div>
            <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px;">
                ${timeLabels.map((label, index) => {
                    const baseColors = [
                        '54, 162, 235',    // Blue
                        '75, 192, 192',    // Teal  
                        '255, 206, 86',    // Yellow
                        '255, 159, 64',    // Orange
                        '255, 99, 132',    // Pink
                        '153, 102, 255'    // Purple
                    ];
                    const color = baseColors[index];
                    return `
                        <div style="display: flex; align-items: center; margin: 2px;">
                            <div style="width: 15px; height: 15px; background: rgba(${color}, 0.7); border-radius: 3px; margin-right: 5px;"></div>
                            <span style="font-size: 10px;">${label.split(' ')[0]}${label.includes('days') ? 'd' : label.includes('years') ? 'y' : ''}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        heatmapDiv.appendChild(legend);
        
        // Add enhanced summary stats
        const stats = document.createElement('div');
        stats.style.marginTop = '15px';
        stats.style.textAlign = 'center';
        stats.style.fontSize = '11px';
        stats.style.color = '#666';
        stats.style.lineHeight = '1.4';
        
        const totalCitations = heatmapData.reduce((total, month) => total + month.data.reduce((sum, val) => sum + val, 0), 0);
        const avgPerCell = Math.round(totalCitations / (heatmapData.length * timeLabels.length));
        
        // Calculate insights
        const columnTotals = columnMaxValues.map((_, index) => 
            heatmapData.reduce((sum, month) => sum + month.data[index], 0)
        );
        const highestColumn = columnTotals.indexOf(Math.max(...columnTotals));
        const lowestColumn = columnTotals.indexOf(Math.min(...columnTotals));
        
        stats.innerHTML = `
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <span><strong>Total Citations:</strong> ${totalCitations.toLocaleString()}</span>
                <span><strong>Average per Cell:</strong> ${avgPerCell.toLocaleString()}</span>
                <span><strong>Most Citations:</strong> ${timeLabels[highestColumn]} (${columnTotals[highestColumn].toLocaleString()})</span>
                <span><strong>Least Citations:</strong> ${timeLabels[lowestColumn]} (${columnTotals[lowestColumn].toLocaleString()})</span>
            </div>
            <div style="margin-top: 5px; font-style: italic;">
                 Each column shows relative intensity within that time period | Hover cells for percentile rankings
            </div>
        `;
        heatmapDiv.appendChild(stats);
        
        heatmapContainer.appendChild(heatmapDiv);
        
            // Debug output
    console.log('Citation heatmap table created successfully with', heatmapData.length, 'months of data');
    
} else {
    document.getElementById('citationHeatmapChart').innerHTML = '<p class="text-center text-muted">No heatmap data available</p>';
    console.log('No heatmap data available');
}

// Initialize sunburst chart
const sunburstData = {{ sunburst_data|safe }} || {};
if (sunburstData && sunburstData.children && sunburstData.children.length > 0) {
    initializeSunburstChart(sunburstData);
} else {
    document.getElementById('sunburstChart').innerHTML = '<p class="text-center text-muted">No subject hierarchy data available</p>';
}
    
    // Country analytics chart  
    const countryData = {{ country_analytics|safe }} || [];
    const worldMapData = {{ world_map_data|safe }} || [];
    
    // Create Plotly choropleth world map
    const worldMapContainer = document.getElementById('countryChart').parentElement;
    const worldMapDiv = document.createElement('div');
    worldMapDiv.id = 'worldMap';
    worldMapDiv.style.height = '400px';
    worldMapDiv.style.marginBottom = '20px';
    worldMapDiv.style.padding = '15px';
    worldMapDiv.style.backgroundColor = '#f8f9fa';
    worldMapDiv.style.borderRadius = '8px';
    worldMapContainer.insertBefore(worldMapDiv, document.getElementById('countryChart'));
    
    // Create Plotly map container (no separate title needed)
    const plotlyMapContainer = document.createElement('div');
    plotlyMapContainer.id = 'plotlyWorldMap';
    plotlyMapContainer.style.height = '360px';
    plotlyMapContainer.style.width = '100%';
    worldMapDiv.appendChild(plotlyMapContainer);
    
    // Prepare data for Plotly choropleth
    const plotlyMapData = worldMapData.filter(country => country.iso_alpha); // Only countries with ISO codes
    
    const choroplethData = [{
        type: 'choropleth',
        locations: plotlyMapData.map(country => country.iso_alpha),
        z: plotlyMapData.map(country => country.value),
        text: plotlyMapData.map(country => 
            `${country.country}<br>` +
            `Retractions: ${country.value.toLocaleString()}<br>` +
            `Post-retraction citations: ${country.post_retraction_citations.toLocaleString()}<br>` +
            `Open access rate: ${country.open_access_percentage.toFixed(1)}%`
        ),
        hovertemplate: '%{text}<extra></extra>',
        colorscale: [
            [0, '#fff5f5'],
            [0.2, '#fecaca'],
            [0.4, '#f87171'],
            [0.6, '#ef4444'],
            [0.8, '#dc2626'],
            [1, '#b91c1c']
        ],
        colorbar: {
            title: 'Retractions',
            titleside: 'right'
        }
    }];
    
    const choroplethLayout = {
        title: false,
        geo: {
            showframe: false,
            showcoastlines: true,
            coastlinecolor: 'lightgray',
            projection: {
                type: 'natural earth'
            }
        },
        margin: { t: 0, r: 0, b: 0, l: 0 },
        font: {
            family: 'system-ui, -apple-system, sans-serif',
            size: 12
        }
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false
    };
    
    // Create the Plotly choropleth map
    Plotly.newPlot('plotlyWorldMap', choroplethData, choroplethLayout, config);
    
    console.log('Plotly choropleth world map initialized with', plotlyMapData.length, 'countries');
    
    // Article Type Chart
    const articleTypeData = {{ article_type_data|safe }} || [];
    console.log('Article Type Data:', articleTypeData);
    
    if (articleTypeData.length > 0) {
        chartInstances['articleType'] = new Chart(
            document.getElementById('articleTypeChart'),
            {
                type: 'bar',
                data: {
                    labels: articleTypeData.map(item => item.type || 'Unknown'),
                    datasets: [{
                        label: 'Count',
                        data: articleTypeData.map(item => item.count || 0),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Article Type'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            }
        );
    }
    
    // Publisher Chart
    const publisherData = {{ publisher_data|safe }} || [];
    console.log('Publisher Data:', publisherData);
    
    if (publisherData.length > 0) {
        chartInstances['publisher'] = new Chart(
            document.getElementById('publisherChart'),
            {
                type: 'bar',
                data: {
                    labels: publisherData.map(item => (item.publisher || 'Unknown').substring(0, 15) + '...'),
                    datasets: [{
                        label: 'Retractions',
                        data: publisherData.map(item => item.count || 0),
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Publisher'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Retractions'
                            }
                        }
                    }
                }
            }
        );
    }
    
    // Open Access Chart
    const accessData = {{ access_analytics|safe }} || {};
    console.log('Access Analytics Data:', accessData);
    
    if (accessData.open_access) {
        chartInstances['openAccess'] = new Chart(
            document.getElementById('openAccessChart'),
            {
                type: 'doughnut',
                data: {
                    labels: ['Open Access', 'Paywalled', 'Unknown'],
                    datasets: [{
                        data: [
                            accessData.open_access.count || 0,
                            accessData.paywalled.count || 0,
                            accessData.unknown.count || 0
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(201, 203, 207, 0.8)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(201, 203, 207, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            }
        );
    }
}

function initializeNetworkVisualization() {
    const networkData = {{ network_data|safe }} || {nodes: [], links: []};
    
    // Clear any existing visualization
    d3.select("#networkVisualization").selectAll("*").remove();
    
    const width = document.getElementById("networkVisualization").clientWidth;
    const height = 600;
    
    const svg = d3.select("#networkVisualization")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
    // Add zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", function(event) {
            container.attr("transform", event.transform);
        });
    
    svg.call(zoom);
    
    // Add zoom controls
    const controls = d3.select("#networkVisualization")
        .append("div")
        .style("position", "absolute")
        .style("top", "10px")
        .style("right", "10px")
        .style("z-index", "1000");
    
    controls.append("button")
        .text("Zoom In")
        .attr("class", "btn btn-sm btn-outline-primary me-1")
        .on("click", function() {
            svg.transition().call(zoom.scaleBy, 1.5);
        });
    
    controls.append("button")
        .text("Zoom Out")
        .attr("class", "btn btn-sm btn-outline-primary me-1")
        .on("click", function() {
            svg.transition().call(zoom.scaleBy, 1 / 1.5);
        });
    
    controls.append("button")
        .text("Reset")
        .attr("class", "btn btn-sm btn-outline-secondary")
        .on("click", function() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });
    
    // Create container for all network elements
    const container = svg.append("g");
    
    const simulation = d3.forceSimulation(networkData.nodes)
        .force("link", d3.forceLink(networkData.links).id(d => d.id))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(d => Math.max(8, d.size / 2) + 2));
    
    const link = container.append("g")
        .selectAll("line")
        .data(networkData.links)
        .enter()
        .append("line")
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", 2);
    
    const node = container.append("g")
        .selectAll("circle")
        .data(networkData.nodes)
        .enter()
        .append("circle")
        .attr("r", d => Math.max(8, d.size / 2))
        .attr("fill", d => d.type === 'journal' ? '#007bff' : '#28a745')
        .style("cursor", "pointer")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
    
    const label = container.append("g")
        .selectAll("text")
        .data(networkData.nodes)
        .enter()
        .append("text")
        .text(d => d.name)
        .attr("font-size", "12px")
        .attr("dx", 15)
        .attr("dy", 4)
        .style("pointer-events", "none");
    
    // Tooltip functionality
    node.on("mouseover", function(event, d) {
        const tooltip = document.getElementById("networkTooltip");
        tooltip.style.display = "block";
        tooltip.style.left = (event.pageX + 10) + "px";
        tooltip.style.top = (event.pageY - 10) + "px";
        tooltip.innerHTML = `
            <strong>${d.full_name}</strong><br>
            Type: ${d.type}<br>
            Papers: ${d.size}
        `;
    })
    .on("mouseout", function() {
        document.getElementById("networkTooltip").style.display = "none";
    });
    
    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
            
        label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    });
    
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

// Utility functions
function refreshChart(chartId) {
    if (chartInstances[chartId]) {
        chartInstances[chartId].update('active');
    }
}

function updateTrendCharts() {
    // Implement filter functionality here
    console.log('Updating trend charts with filters...');
}

function updateNetworkChart() {
    const networkType = document.getElementById('networkTypeFilter').value;
    const networkData = {{ network_data|safe }} || {nodes: [], links: []};
    
    // Filter nodes and links based on network type
    let filteredNodes = [];
    let filteredLinks = [];
    
    switch(networkType) {
        case 'journals':
            filteredNodes = networkData.nodes.filter(node => node.type === 'journal');
            filteredLinks = networkData.links.filter(link => 
                link.type === 'journal-country' && 
                filteredNodes.some(n => n.id === link.source) &&
                networkData.nodes.filter(n => n.type === 'country').some(n => n.id === link.target)
            );
            // Add country nodes that are connected to journals
            const connectedCountryIds = [...new Set(filteredLinks.map(l => l.target))];
            const connectedCountries = networkData.nodes.filter(node => 
                node.type === 'country' && connectedCountryIds.includes(node.id)
            );
            filteredNodes = [...filteredNodes, ...connectedCountries];
            break;
            
        case 'subjects':
            filteredNodes = networkData.nodes.filter(node => node.type === 'subject');
            filteredLinks = networkData.links.filter(link => 
                link.type === 'subject-journal' &&
                filteredNodes.some(n => n.id === link.source) &&
                networkData.nodes.filter(n => n.type === 'journal').some(n => n.id === link.target)
            );
            // Add journal nodes that are connected to subjects
            const connectedJournalIds = [...new Set(filteredLinks.map(l => l.target))];
            const connectedJournals = networkData.nodes.filter(node => 
                node.type === 'journal' && connectedJournalIds.includes(node.id)
            );
            filteredNodes = [...filteredNodes, ...connectedJournals];
            break;
            
        case 'combined':
        default:
            filteredNodes = networkData.nodes;
            filteredLinks = networkData.links;
            break;
    }
    
    // Clear and reinitialize the network visualization
    d3.select("#networkVisualization").selectAll("*").remove();
    
    const width = document.getElementById("networkVisualization").clientWidth;
    const height = 600;
    
    const svg = d3.select("#networkVisualization")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
    // Add zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", function(event) {
            container.attr("transform", event.transform);
        });
    
    svg.call(zoom);
    
    // Add zoom controls
    const controls = d3.select("#networkVisualization")
        .append("div")
        .style("position", "absolute")
        .style("top", "10px")
        .style("right", "10px")
        .style("z-index", "1000");
    
    controls.append("button")
        .text("Zoom In")
        .attr("class", "btn btn-sm btn-outline-primary me-1")
        .on("click", function() {
            svg.transition().call(zoom.scaleBy, 1.5);
        });
    
    controls.append("button")
        .text("Zoom Out")
        .attr("class", "btn btn-sm btn-outline-primary me-1")
        .on("click", function() {
            svg.transition().call(zoom.scaleBy, 1 / 1.5);
        });
    
    controls.append("button")
        .text("Reset")
        .attr("class", "btn btn-sm btn-outline-secondary")
        .on("click", function() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });
    
    // Create container for all network elements
    const container = svg.append("g");
    
    const simulation = d3.forceSimulation(filteredNodes)
        .force("link", d3.forceLink(filteredLinks).id(d => d.id))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(d => Math.max(8, d.size / 2) + 2));
    
    const link = container.append("g")
        .selectAll("line")
        .data(filteredLinks)
        .enter()
        .append("line")
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", d => Math.max(1, d.value / 10));
    
    const node = container.append("g")
        .selectAll("circle")
        .data(filteredNodes)
        .enter()
        .append("circle")
        .attr("r", d => Math.max(8, d.size / 2))
        .attr("fill", d => {
            switch(d.type) {
                case 'journal': return '#007bff';
                case 'country': return '#28a745';
                case 'subject': return '#ffc107';
                default: return '#6c757d';
            }
        })
        .style("cursor", "pointer")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
    
    const label = container.append("g")
        .selectAll("text")
        .data(filteredNodes)
        .enter()
        .append("text")
        .text(d => d.name)
        .attr("font-size", "12px")
        .attr("dx", 15)
        .attr("dy", 4)
        .style("pointer-events", "none");
    
    // Tooltip functionality
    node.on("mouseover", function(event, d) {
        d3.select(this).attr("r", Math.max(12, d.size / 2 + 4));
        
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background", "rgba(0,0,0,0.8)")
            .style("color", "white")
            .style("padding", "8px")
            .style("border-radius", "4px")
            .style("font-size", "12px")
            .style("z-index", "1000");
        
        tooltip.transition()
            .duration(200)
            .style("opacity", .9);
            
        tooltip.html(`
            <strong>${d.full_name}</strong><br/>
            Type: ${d.type}<br/>
            ${d.retraction_count ? `Retractions: ${d.retraction_count}` : ''}
            ${d.post_retraction_citations ? `<br/>Post-retraction citations: ${d.post_retraction_citations}` : ''}
        `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function(event, d) {
        d3.select(this).attr("r", Math.max(8, d.size / 2));
        d3.selectAll(".tooltip").remove();
    });
    
    simulation
        .nodes(filteredNodes)
        .on("tick", ticked);
    
    simulation.force("link")
        .links(filteredLinks);
    
    function ticked() {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
        
        label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    }
    
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
    
    console.log(`Network updated: ${networkType} view with ${filteredNodes.length} nodes and ${filteredLinks.length} links`);
}

function initializeSunburstChart(data) {
    // Clear any existing chart
    d3.select("#sunburstChart").selectAll("*").remove();
    
    // Get container dimensions to make it responsive
    const container = document.getElementById('sunburstChart');
    const containerRect = container.getBoundingClientRect();
    const width = Math.min(containerRect.width || 350, 350);
    const height = Math.min(containerRect.height || 350, 350);
    const radius = Math.min(width, height) / 2 - 10;
    
    const svg = d3.select("#sunburstChart")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);
    
    // Create color scale
    const color = d3.scaleOrdinal(d3.schemeCategory10);
    
    // Create partition layout
    const partition = d3.partition()
        .size([2 * Math.PI, radius]);
    
    // Create hierarchy
    const root = d3.hierarchy(data)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value);
    
    // Apply partition
    partition(root);
    
    // Create arc generator
    const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1);
    
    // Add arcs
    const arcs = svg.selectAll("path")
        .data(root.descendants())
        .enter()
        .append("path")
        .attr("d", arc)
        .style("fill", d => {
            if (d.depth === 0) return "#f8f9fa"; // Center
            if (d.depth === 1) return color(d.data.name); // Broad categories
            return d3.color(color(d.parent.data.name)).brighter(0.5); // Specific fields
        })
        .style("stroke", "#fff")
        .style("stroke-width", 1)
        .style("cursor", "pointer")
        .on("mouseover", function(event, d) {
            if (d.depth > 0) {
                d3.select(this).style("opacity", 0.8);
                
                // Show tooltip
                const tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0)
                    .style("position", "absolute")
                    .style("background", "rgba(0,0,0,0.8)")
                    .style("color", "white")
                    .style("padding", "8px")
                    .style("border-radius", "4px")
                    .style("font-size", "12px")
                    .style("z-index", "1000");
                
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                    
                const fullName = d.data.full_name || d.data.name;
                tooltip.html(`
                    <strong>${fullName}</strong><br/>
                    Papers: ${d.value.toLocaleString()}<br/>
                    ${d.depth === 1 ? 'Broad Category' : 'Specific Field'}
                `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }
        })
        .on("mouseout", function(event, d) {
            d3.select(this).style("opacity", 1);
            d3.selectAll(".tooltip").remove();
        })
        .on("click", function(event, d) {
            if (d.depth > 0) {
                const fullName = d.data.full_name || d.data.name;
                const searchUrl = d.depth === 1 ? 
                    `/search/?broad_subject=${encodeURIComponent(d.data.name)}` :
                    `/search/?subject=${encodeURIComponent(fullName)}`;
                window.open(searchUrl, '_blank');
            }
        });
    
    // Add text labels for broad categories only
    svg.selectAll("text")
        .data(root.descendants().filter(d => d.depth === 1 && d.value > 50))
        .enter()
        .append("text")
        .attr("transform", function(d) {
            const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
            const y = (d.y0 + d.y1) / 2;
            return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
        })
        .attr("dy", "0.35em")
        .style("text-anchor", function(d) {
            return (d.x0 + d.x1) / 2 < Math.PI ? "start" : "end";
        })
        .style("font-size", "10px")
        .style("font-weight", "bold")
        .style("fill", "#333")
        .style("pointer-events", "none")
        .text(d => d.data.name.length > 12 ? d.data.name.substring(0, 12) + "..." : d.data.name);
    
    // Add center text
    svg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .style("font-size", "12px")
        .style("font-weight", "bold")
        .style("fill", "#666")
        .text("Subjects");
    
    console.log('Sunburst chart initialized with', data.children.length, 'broad categories');
}

// Add loading indicators
function showLoading(elementId) {
    document.getElementById(elementId).innerHTML = '<div class="chart-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
}

// Responsive chart handling
window.addEventListener('resize', function() {
    Object.values(chartInstances).forEach(chart => {
        if (chart) chart.resize();
    });
});

// Real-time update functionality
let autoRefreshTimer = null;

document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh toggle
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const refreshInterval = document.getElementById('refreshInterval');
    const manualRefresh = document.getElementById('manualRefresh');
    const lastUpdated = document.getElementById('lastUpdated');
    const updateStatus = document.getElementById('updateStatus');
    const updateLoading = document.getElementById('updateLoading');
    
    // Enable/disable interval selector based on toggle
    autoRefreshToggle.addEventListener('change', function() {
        refreshInterval.disabled = !this.checked;
        
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // Update interval when changed
    refreshInterval.addEventListener('change', function() {
        if (autoRefreshToggle.checked) {
            stopAutoRefresh();
            startAutoRefresh();
        }
    });
    
    // Manual refresh button
    manualRefresh.addEventListener('click', function() {
        refreshAnalytics();
    });
    
    function startAutoRefresh() {
        const interval = parseInt(refreshInterval.value);
        autoRefreshTimer = setInterval(refreshAnalytics, interval);
        console.log('Auto-refresh started:', interval + 'ms');
    }
    
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            console.log('Auto-refresh stopped');
        }
    }
    
    function refreshAnalytics() {
        // Show loading indicator
        updateLoading.style.display = 'inline-block';
        updateStatus.style.display = 'none';
        
        // Reload the page to get fresh data
        setTimeout(function() {
            window.location.reload();
        }, 500);
    }
    
    // Show temporary success indicator when page loads
    function showUpdateSuccess() {
        updateLoading.style.display = 'none';
        updateStatus.style.display = 'inline-block';
        lastUpdated.textContent = new Date().toLocaleString();
        
        setTimeout(function() {
            updateStatus.style.display = 'none';
        }, 3000);
    }
    
    // Check if page was refreshed automatically
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auto_refreshed') === 'true') {
        showUpdateSuccess();
        // Remove the parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});
</script>
{% endblock %} 